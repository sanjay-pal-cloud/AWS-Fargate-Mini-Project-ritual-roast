pipeline {
    agent any
    
    
    environment {
        ECR_REPO = "340234701671.dkr.ecr.ap-south-1.amazonaws.com/ritual-roast"
        ECS_SERVICE = "ritual-roast-service"
        ECS_CLUSTER = "ritual-roast-cluster"
        TASK_DEF = "ritual-roast"
        IMAGE_TAG = "v1"
    }
    stages {
        stage('checkout') {
            steps {
                git 'https://github.com/sanjay-pal-cloud/AWS-Fargate-Mini-Project-ritual-roast.git'
            }
        }
        
        stage('Build Docker Image') {
            steps {
                sh 'docker build -t 340234701671.dkr.ecr.ap-south-1.amazonaws.com/ritual-roast .'
            }
        }
        
        stage('Login and Push') {
            steps {
                withCredentials([aws(accessKeyVariable: 'AWS_ACCESS_KEY_ID', credentialsId: 'aws-creds', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY')]) {
    // some block
}
                script {
                    sh '''
                    aws ecr get-login-password --region ap-south-1 | docker login --username AWS --password-stdin 340234701671.dkr.ecr.ap-south-1.amazonaws.com
                    docker push $ECR_REPO:$IMAGE_TAG
                    '''
                }    
            }
            
            stage('Deploy') {
            steps {
                withCredentials([aws(accessKeyVariable: 'AWS_ACCESS_KEY_ID', credentialsId: 'aws-creds', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY')]) {
    // some block
}
                script {
                    sh '''
                    # Fetch current task definition JSON
                        CURR_TASK_DEF = $(aws describe-task-definition \
                        --task-definition $TASK_DEF \
                        --query 'taskDefinition' \
                        --output json) 

                        # Update container image in task definition
                        $(CURR_TASK_DEF) | \
                          UPDATE_TASK_DEF = $(jq --arg IMAGE "$ECR_REPO:$IMAGE_TAG" '.containerDefinitions[0].image = $IMAGE')

                        # Register new task definition
                        NEW_TASK_DEF_ARN = $(aws ecs register-task-definition \
                          --cli-input-json $UPDATE_TASK_DEF \
                          --query 'taskDefinition.taskDefinitionArn' \
                          --output text)

                        # Update ECS service
                        aws ecs update-service \
                          --cluster $ECS_CLUSTER \
                          --service $ECS_SERVICE \
                          --task-definition $NEW_TASK_DEF_ARN \
                          --force-new-deployment
                    '''
                    }    
                }
            }
        }
    }
}
